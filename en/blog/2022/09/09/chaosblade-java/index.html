<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.1.0">
<title data-rh="true">ChaosBlade Java 场景性能优化，那些你不知道的事 | ChaosBlade</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" property="og:image" content="https://chaosblade.io/en/img/cb-logo.png"><meta data-rh="true" name="twitter:image" content="https://chaosblade.io/en/img/cb-logo.png"><meta data-rh="true" property="og:url" content="https://chaosblade.io/en/blog/2022/09/09/chaosblade-java"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" name="twitter:card" content="summary"><meta data-rh="true" property="og:title" content="ChaosBlade Java 场景性能优化，那些你不知道的事 | ChaosBlade"><meta data-rh="true" name="description" content="本文会着重介绍什么chaosblade java场景性能优化的实现。"><meta data-rh="true" property="og:description" content="本文会着重介绍什么chaosblade java场景性能优化的实现。"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2022-09-09T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://github.com/binbin0325"><meta data-rh="true" property="article:tag" content="chaosblade"><link data-rh="true" rel="icon" href="/en/img/favicon/favicon.ico"><link data-rh="true" rel="canonical" href="https://chaosblade.io/en/blog/2022/09/09/chaosblade-java"><link data-rh="true" rel="alternate" href="https://chaosblade.io/en/blog/2022/09/09/chaosblade-java" hreflang="en"><link data-rh="true" rel="alternate" href="https://chaosblade.io/blog/2022/09/09/chaosblade-java" hreflang="zh"><link data-rh="true" rel="alternate" href="https://chaosblade.io/blog/2022/09/09/chaosblade-java" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://AJZLJ48ZRO-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/en/blog/rss.xml" title="ChaosBlade RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/en/blog/atom.xml" title="ChaosBlade Atom Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-FY5W27B8XH"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-FY5W27B8XH",{anonymize_ip:!0})</script>


<link rel="search" type="application/opensearchdescription+xml" title="ChaosBlade" href="/en/opensearch.xml">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;600&display=block">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600&display=block">
<script src="https://buttons.github.io/buttons.js"></script><link rel="stylesheet" href="/en/assets/css/styles.ed732878.css">
<link rel="preload" href="/en/assets/js/runtime~main.3e71e79d.js" as="script">
<link rel="preload" href="/en/assets/js/main.67b64ba6.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();null!==e?t(e):window.matchMedia("(prefers-color-scheme: dark)").matches?t("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,t("light"))}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div role="region" aria-label="theme.common.skipToMainContent"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><div class="announcementBar_mb4j" role="banner"><div class="announcementBarPlaceholder_vyr4"></div><div class="content_knG7 announcementBarContent_xLdY">⭐️  &nbsp; If you like ChaosBlade, give it a star on <a target="_blank" rel="noopener noreferrer" href="https://github.com/chaosblade-io/chaosblade">GitHub</a>! ⭐️</div><button type="button" aria-label="Close" class="clean-btn close closeButton_CVFx announcementBarClose_gvF7"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/en/"><div class="navbar__logo"><img src="/en/img/cb-head.png" alt="ChaosBlade" class="themedImage_ToTc themedImage--light_HNdA"><img src="/en/img/cb-head.png" alt="ChaosBlade" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">ChaosBlade</b></a><div class="navbar__item dropdown dropdown--hoverable"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/en/docs/">1.7.0</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/en/docs/next/">Next</a></li><li><a class="dropdown__link" href="/en/docs/">1.7.0</a></li></ul></div><a class="navbar__item navbar__link" href="/en/docs">Documentation</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/en/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/chaosblade-io/chaosblade" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-githab-link"></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>English</a><ul class="dropdown__menu"><li><a href="/en/blog/2022/09/09/chaosblade-java" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="en">English</a></li><li><a href="/blog/2022/09/09/chaosblade-java" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="zh">简体中文</a></li></ul></div><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">全部博文</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/en/blog/2022/09/09/chaosblade-java">ChaosBlade Java 场景性能优化，那些你不知道的事</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/en/blog/2022/06/24/ChaosBlade-Box-a-New-Version-of-the-Chaos-Engineering-Platform-Has-Released-ch">ChaosBlade-Box全新混沌工程平台 -- 助力企业混沌工程落地</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/en/blog/2022/06/24/ChaosBlade-Box-a-New-Version-of-the-Chaos-Engineering-Platform-Has-Released">ChaosBlade-Box, a New Version of the Chaos Engineering Platform Has Released</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/en/blog/2022/06/24/ChaosBlade-Box-new-release">混沌工程平台 ChaosBlade-Box 新版重磅发布</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/en/blog/2022/03/03/ChaosBlade-From-the-Chaos-Engineering-Experiment-Tool-to-the-Chaos-Engineering-Platform">ChaosBlade, From the Chaos Engineering Experiment Tool to the Chaos Engineering Platform</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/en/blog/2021/12/08/chaos-engineering-value">被你质疑价值的混沌工程，阿里巴巴已落地实践了9年</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/en/blog/2021/06/06/summer-2021">暑期2021</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/en/blog/2021/05/21/chaos-engineering">混沌工程介绍与实践</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/en/blog/2020/08/06/chaosblade-start-5">ChaosBlade：从零开始的混沌工程（五）</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/en/blog/2020/07/22/chaosblade-start-4">ChaosBlade：从零开始的混沌工程（四）</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/en/blog/2020/06/15/chaosblade-start-3">ChaosBlade：从零开始的混沌工程（三）</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/en/blog/2020/06/09/chaosblade-start-2">ChaosBlade：从零开始的混沌工程（二）</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/en/blog/2020/06/04/chaosblade-start-1">ChaosBlade：从零开始的混沌工程（一）</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/en/blog/2019/10/17/chaosblade-cloud-native">ChaosBlade：云原生架构下的混沌工程探索和实践</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/en/blog/2019/07/03/chaosblade-chaos-engineering-tools">Chaosblade, 阿里一个超级牛逼的混沌实验实施工具</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="title_f1Hy" itemprop="headline">ChaosBlade Java 场景性能优化，那些你不知道的事</h1><div class="container_mt6G margin-vert--md"><time datetime="2022-09-09T00:00:00.000Z" itemprop="datePublished">September 9, 2022</time> · <!-- -->28 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/binbin0325" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/28588342?v=4" alt="张斌斌（@binbin0325）"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/binbin0325" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">张斌斌（@binbin0325）</span></a></div><small class="avatar__subtitle" itemprop="description">Committer of ChaosBlade</small></div></div></div></div></header><div id="post-content" class="markdown" itemprop="articleBody"><p><a href="https://chaosblade.io/" target="_blank" rel="noopener noreferrer">ChaosBlade</a> 是阿里巴巴开源的一款遵循混沌工程原理和混沌实验模型的实验注入工具，帮助企业提升分布式系统的容错能力，并且在企业上云或往云原生系统迁移过程中业务连续性保障。</p><p>目前支持的场景有：基础资源、Java 应用、C++ 应用、Docker 容器以及 Kubernetes 平台。该项目将场景按领域实现封装成单独的项目，不仅可以使领域内场景标准化实现，而且非常方便场景水平和垂直扩展，通过遵循混沌实验模型，实现 ChaosBlade cli 统一调用。</p><p>不过Java场景下的故障注入目前有一些性能问题,主要体现在故障注入时会让CPU的使用率大幅度抖动,严重情况下可能会导致CPU的使用率100%。这种情况对于线下服务的影响还好，但是对于线上服务就比较严重了，因为CPU的使用率较高有可能会导致服务的整体性能变差，从而影响接口的耗时。</p><p><strong>通过对ChaosBlade Java 场景的性能优化，使CPU在故障注入时的抖动得到了有效的控制，不会再出现CPU使用率达到100%的抖动，经过测试在线上8C，4G，QPS 3K左右的服务实例上注入Dubbo 自定义抛异常的故障，CPU的使用率可以控制在40%左右的瞬时抖动范围内,性能整体提升近2.5倍。</strong></p><p>本文将会详细的介绍影响性能的问题点以及是如何对这些问题进行优化的。</p><h1>2.Java场景</h1><p>在介绍前先了解下ChaosBlade Java场景的注入流程。</p><p><img loading="lazy" src="https://cdn.nlark.com/yuque/0/2022/png/215568/1662014005578-270f85a6-fd83-4e0a-b43b-dc97eb26f510.png#clientId=u52ad7d43-5028-4&amp;crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;from=paste&amp;height=232&amp;id=u536ca7fe&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=464&amp;originWidth=1598&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=107988&amp;status=done&amp;style=none&amp;taskId=u5f0cd5e6-7193-4e6e-8b83-392a6b276dc&amp;title=&amp;width=799" alt="image.png" class="img_ev3q">Java场景的故障注入是基于字节码增强框架JVM-Sandbox实现的，注入一个故障分为两步：</p><ol><li>ChaosBlade 执行prepare命令，触发sandbox对目标JVM挂载 Java agent。</li><li>ChaosBlade 执行create命令，触发sandbox对目标JVM进行字节码增强，从而达到故障注入的目的。</li></ol><h1>3.prepare(挂载)阶段优化</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="31-现象">3.1 现象<a class="hash-link" href="#31-现象" title="Direct link to heading">​</a></h2><p>本地模拟一个简单的HTTP服务，控制其CPU Idle在50%左右，当执行blade prepare jvm --pid挂载agent后，发现CPU空闲率迅速下降，并且下降的幅度较大。在生产中进行故障注入有可能会直接让Idle掉低从而触发告警</p><p><img loading="lazy" src="https://cdn.nlark.com/yuque/0/2022/png/215568/1662014042664-6aa32560-c4ad-4cf9-af1c-12bbe48d3ef6.png#clientId=u52ad7d43-5028-4&amp;crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;from=paste&amp;height=172&amp;id=u78f2e45e&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=274&amp;originWidth=1188&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=82193&amp;status=done&amp;style=none&amp;taskId=u4e1a626e-a680-4a97-899e-090dc4062f5&amp;title=&amp;width=745" alt="image.png" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="32-定位">3.2 定位<a class="hash-link" href="#32-定位" title="Direct link to heading">​</a></h2><p>通过采集CPU profile生成火焰图来观察在执行blade prepare时CPU的使用情况，如下图可以看到loadPlugins方法是资源消耗的重灾区</p><p><a href="https://cdn.nlark.com/yuque/0/2022/png/215568/1662014182779-f714d227-c3c4-45ce-822b-7b68bc23e0b8.png#clientId=u52ad7d43-5028-4&amp;crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;from=paste&amp;height=325&amp;id=u24cbcf93&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=484&amp;originWidth=1074&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=354434&amp;status=done&amp;style=none&amp;taskId=u2fe4bf22-dd36-46c5-adf4-77b0adb50c6&amp;title=&amp;width=721" target="_blank" rel="noopener noreferrer">image.png</a></p><p>loadPlugins方法中主要是加载ChaosBlade Java中支持的全部插件，例如dubbo,redis,kafka等。当加载了这些插件后就可以进行故障注入了。加载插件的过程中会对插件中定义的类以及方法进行字节码增强。</p><p><img loading="lazy" src="https://cdn.nlark.com/yuque/0/2022/png/215568/1662014673785-ea235bde-77c7-49da-a083-df8cf33a8fee.png#clientId=u1e121cd7-cea1-4&amp;crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;from=ui&amp;id=u9a60fe1b&amp;margin=%5Bobject%20Object%5D&amp;name=attach%26%E5%8A%A0%E8%BD%BD.png&amp;originHeight=258&amp;originWidth=1532&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=30862&amp;status=done&amp;style=none&amp;taskId=u69b3ea87-d7a9-4501-ab63-a88d77fea12&amp;title=" alt="attach&amp;加载.png" class="img_ev3q"></p><p>导致CPU消耗的问题就在于加载全量的插件耗时较大，而我们故障注入时会选择具体某个插件进行故障注入，显然全量加载并不是最优解</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="33-优化">3.3 优化<a class="hash-link" href="#33-优化" title="Direct link to heading">​</a></h2><p>优化思路:既然故障注入时会选择具体的插件，那么通过懒加载的方式即可解决，当我们要针对哪一个插件故障注入就加载哪个插件，加载的粒度变小，CPU的消耗自然就小了
<img loading="lazy" src="https://cdn.nlark.com/yuque/0/2022/png/215568/1662014682629-b696cbe2-83ff-42d4-bcd8-ffa3212b51c3.png#clientId=u1e121cd7-cea1-4&amp;crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;from=ui&amp;id=uf7664a78&amp;margin=%5Bobject%20Object%5D&amp;name=attach.png&amp;originHeight=250&amp;originWidth=1438&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=28442&amp;status=done&amp;style=none&amp;taskId=ua75afa23-dfe9-4a58-967f-918be317eac&amp;title=" alt="attach.png" class="img_ev3q"></p><p>核心代码：
在故障注入阶段，通过指定的插件进行懒加载。</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">private void lazyLoadPlugin(ModelSpec modelSpec, Model model) throws ExperimentException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    PluginLifecycleListener listener = ManagerFactory.getListenerManager().getPluginLifecycleListener();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (listener == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new ExperimentException(&quot;can get plugin listener&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    PluginBeans pluginBeans = ManagerFactory.getPluginManager().getPlugins(modelSpec.getTarget());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (pluginBeans == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new ExperimentException(&quot;can get plugin bean&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (pluginBeans.isLoad()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    listener.add(pluginBean);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ManagerFactory.getPluginManager().setLoad(pluginBeans, modelSpec.getTarget());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>详细代码PR:<a href="https://github.com/chaosblade-io/chaosblade-exec-jvm/pull/233" target="_blank" rel="noopener noreferrer">https://github.com/ChaosBlade-io/ChaosBlade-exec-jvm/pull/233</a></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="34-改进后效果">3.4 改进后效果<a class="hash-link" href="#34-改进后效果" title="Direct link to heading">​</a></h2><p>CPU Idle 下降幅度降低
<img loading="lazy" src="https://cdn.nlark.com/yuque/0/2022/png/215568/1662014777027-115887c7-3f45-4920-ac86-386ea965676b.png#clientId=u1e121cd7-cea1-4&amp;crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;from=paste&amp;height=214&amp;id=u9b9f16de&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=378&amp;originWidth=1157&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=75312&amp;status=done&amp;style=none&amp;taskId=u0d4cf015-6977-4180-af58-a7e30591c40&amp;title=&amp;width=655.5" alt="image.png" class="img_ev3q"></p><p>火焰图中的CPU使用率几乎“消失”</p><p><img loading="lazy" src="https://cdn.nlark.com/yuque/0/2022/png/215568/1662014826580-a39a6aeb-1aaf-4395-9e86-a52c722a7e93.png#clientId=u1e121cd7-cea1-4&amp;crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;from=paste&amp;height=284&amp;id=u706b2e3e&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=484&amp;originWidth=1146&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=413253&amp;status=done&amp;style=none&amp;taskId=ua87d9097-7a43-4975-b0b4-35889169026&amp;title=&amp;width=673" alt="image.png" class="img_ev3q"></p><h1>4.create(注入)阶段优化</h1><p>在实际使用中发现故障注入导致CPU Idle跌底的情况比较多，跌底的持续时间是比较短暂的基本都在20S左右，有一些情况是和目标服务的业务代码有关系或者是和目标服务的jvm参数设置有关，本文只介绍由ChaosBlade导致的或间接导致的CPU Idle跌底问题。</p><p><img loading="lazy" src="https://cdn.nlark.com/yuque/0/2022/png/215568/1662014860747-8535e13d-dfa9-45eb-b9ca-56a51487c8a6.png#clientId=u1e121cd7-cea1-4&amp;crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;from=paste&amp;height=203&amp;id=uec06453d&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=335&amp;originWidth=1188&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=66082&amp;status=done&amp;style=none&amp;taskId=u80bd32f1-7e4c-4bc7-821a-6d0063e4e10&amp;title=&amp;width=719" alt="image.png" class="img_ev3q"></p><blockquote><p>CPU Idle跌底:这里指的是CPU 空闲率降低为0，同时意味着CPU 使用率达到了100%</p></blockquote><h2 class="anchor anchorWithStickyNavbar_LWe7" id="41-dubbo故障优化">4.1 dubbo故障优化<a class="hash-link" href="#41-dubbo故障优化" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="411-问题描述">4.1.1 问题描述<a class="hash-link" href="#411-问题描述" title="Direct link to heading">​</a></h3><p>ChaosBlade中支持对dubbo provider或者consumer进行故障注入（例如抛异常），当一个服务既是provider又是consumer的时候，如果对provider故障注入则会触发bug，有可能会导致CPU Idle跌底。</p><p><strong>正常情况：</strong>一个既是provider又是consumer的服务，它的请求处理流程是流量会首先进入到provider经过处理后交由业务逻辑执行，最后通过consumer将请求转发出去。</p><p><img loading="lazy" src="https://cdn.nlark.com/yuque/0/2022/png/215568/1662015356816-ccd9ffd2-8b25-4299-8271-109f11f3af83.png#clientId=u2a5f2d5c-785c-4&amp;crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;from=paste&amp;height=223&amp;id=ua9805d3c&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=446&amp;originWidth=2062&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=84435&amp;status=done&amp;style=none&amp;taskId=u363047b1-4e34-4518-ac7d-973c7beb21d&amp;title=&amp;width=1031" alt="image.png" class="img_ev3q"></p><p><strong>针对consumer故障注入：</strong>当利用ChaosBlade对consumer进行故障注入时，流量到达consumer就会抛出异常，不会将流量真正的转发出去，从而达到一个模拟故障发生的效果。</p><p><img loading="lazy" src="https://cdn.nlark.com/yuque/0/2022/png/215568/1662015418084-149453ef-e51d-4ebf-ae78-ef72bd75c610.png#clientId=u2a5f2d5c-785c-4&amp;crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;from=paste&amp;height=310&amp;id=u4e441628&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=620&amp;originWidth=2080&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=109051&amp;status=done&amp;style=none&amp;taskId=u07dd9a40-afa8-4df7-9e7e-a34c5b07b51&amp;title=&amp;width=1040" alt="image.png" class="img_ev3q"></p><p><strong>针对provider故障注入：</strong>当利用ChaosBlade对provider进行故障注入时，流量到达provider就会抛出异常，不会将流量向下转发。</p><p><img loading="lazy" src="https://cdn.nlark.com/yuque/0/2022/png/215568/1662015421125-2b212d41-659f-42b7-af77-75bd47f6a427.png#clientId=u2a5f2d5c-785c-4&amp;crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;from=paste&amp;height=311&amp;id=uc41e07ca&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=622&amp;originWidth=2082&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=108382&amp;status=done&amp;style=none&amp;taskId=u5ce1b3ab-81a4-45fb-8850-3fd25e6c4a8&amp;title=&amp;width=1041" alt="image.png" class="img_ev3q"></p><p><strong>上面说的都是预期效果，实际上ChaosBlade无论是对provider或者consumer进行故障注入时，都会同时provider以及consumer同时进行故障注入，这就有可能造成额外的资源浪费</strong>。</p><ol><li>字节码增强的类变的多了</li><li>例如当注入provider故障时，我们希望流量不要经过业务逻辑，因为一旦是在consumer也抛出了异常，流量返回时自然要经过业务逻辑的异常处理（例如打印error日志，重试等），这就有可能因为业务逻辑的处理问题导致CPU Idle下降。</li></ol><p><img loading="lazy" src="https://cdn.nlark.com/yuque/0/2022/png/215568/1662015488924-3b805ca7-7b55-4500-8225-c90e5d7285d6.png#clientId=u2a5f2d5c-785c-4&amp;crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;from=paste&amp;height=306&amp;id=u4b3c3902&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=612&amp;originWidth=2108&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=112277&amp;status=done&amp;style=none&amp;taskId=u8fd572bc-c7eb-4e0f-b4cc-3423c81e79a&amp;title=&amp;width=1054" alt="image.png" class="img_ev3q"></p><p><strong>问题原因:因为ChaosBlade的字节码增强逻辑是按照插件的粒度进行的，例如dubbo就属于一个插件，不过像dubbo和kafka这种既有针对provider又有针对consumer故障注入的插件就会同时对provider和consumer都注入故障了。</strong></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="412-优化">4.1.2 优化<a class="hash-link" href="#412-优化" title="Direct link to heading">​</a></h3><p>在加载插件的时候，根据具体加载的插件名按需加载，例如执行命令:</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">./blade create dubbo throwCustomException --provider --exception Java.lang.Exception --service org.apache.dubbo.UserProvider --methodname GetUser </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>代表实际要针对dubbo的provider注入故障，那么就只加载provider插件进行字节码增强。</p><p>修改的核心代码：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">private void lazyLoadPlugin(ModelSpec modelSpec, Model model) throws ExperimentException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ...... 省略</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (PluginBean pluginBean : pluginBeans.getPluginBeans()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String flag = model.getMatcher().get(pluginBean.getName());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (&quot;true&quot;.equalsIgnoreCase(flag)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            listener.add(pluginBean);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        listener.add(pluginBean);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ...... 省略</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>相关pr:<a href="https://github.com/chaosblade-io/chaosblade-exec-jvm/pull/267" target="_blank" rel="noopener noreferrer">https://github.com/ChaosBlade-io/ChaosBlade-exec-jvm/pull/267</a></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="42-自定义脚本故障优化">4.2 自定义脚本故障优化<a class="hash-link" href="#42-自定义脚本故障优化" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="421-问题描述">4.2.1 问题描述<a class="hash-link" href="#421-问题描述" title="Direct link to heading">​</a></h3><p>在使用ChaosBlade 注入自定义脚本的故障时导致CPU Idle跌底，自定义脚本是ChaosBlade jvm故障中支持的一种方式，指的是用户可以编写任意一段Java代码，然后将这段代码注入到对应的目标类和方法上，这样的方式灵活度非常高，通过ChaosBlade的自定义脚本注入故障可以做很多事情。</p><p>ChaosBlade命令:</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">./blade c jvm script --classname com.example.xxx.HelloController --methodname Hello --script-content </span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="422-问题排查">4.2.2 问题排查<a class="hash-link" href="#422-问题排查" title="Direct link to heading">​</a></h3><p>我们抓取了故障注入时的火焰图以及jstack日志，通过jstack打印的线程堆栈发现了一些问题。</p><ol><li>在故障注入后线程数量会突然上升</li><li>有部分线程是blocked状态</li></ol><p><strong>故障注入前:</strong></p><p><img loading="lazy" src="https://cdn.nlark.com/yuque/0/2022/png/215568/1662024346261-4f84e22b-db13-4626-a28d-8bb0edbbed64.png#clientId=u0a32c8ae-289c-4&amp;crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;from=paste&amp;height=421&amp;id=u3c6a7cd4&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=716&amp;originWidth=612&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=84822&amp;status=done&amp;style=none&amp;taskId=u0a4730b2-934b-4365-8cf9-509d3a08f42&amp;title=&amp;width=360" alt="image.png" class="img_ev3q"></p><p><strong>故障注入后:</strong></p><p><img loading="lazy" src="https://cdn.nlark.com/yuque/0/2022/png/215568/1662024384319-6c65bb55-30d3-454c-9903-3259db20ada5.png#clientId=u0a32c8ae-289c-4&amp;crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;from=paste&amp;height=456&amp;id=uccb4930e&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=768&amp;originWidth=612&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=97382&amp;status=done&amp;style=none&amp;taskId=ube55edef-27ae-4a7b-91fa-f9c7096278c&amp;title=&amp;width=363" alt="image.png" class="img_ev3q"></p><p>BLOCKED的线程堆栈:</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Stack Trace is: </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Java.lang.Thread.State: RUNNABLE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">at Java.util.zip.ZipFile.getEntryTime(Native Method)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">at Java.util.zip.ZipFile.getZipEntry(ZipFile.Java:586)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">at Java.util.zip.ZipFile.access$900(ZipFile.Java:60)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">at Java.util.zip.ZipFile$ZipEntryIterator.next(ZipFile.Java:539)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- locked &lt;0x00000006c0a57670&gt; (a sun.net.www.protocol.jar.URLJarFile)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">at Java.util.zip.ZipFile$ZipEntryIterator.nextElement(ZipFile.Java:514)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">at Java.util.zip.ZipFile$ZipEntryIterator.nextElement(ZipFile.Java:495)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">at Java.util.jar.JarFile$JarEntryIterator.next(JarFile.Java:258)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">at Java.util.jar.JarFile$JarEntryIterator.nextElement(JarFile.Java:267)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">at Java.util.jar.JarFile$JarEntryIterator.nextElement(JarFile.Java:248)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">at com.alibaba.ChaosBlade.exec.plugin.jvm.script.Java.JavaCodeScriptEngine$InMemoryJavaFileManager.processJar(JavaCodeScriptEngine.Java:421)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">at com.alibaba.ChaosBlade.exec.plugin.jvm.script.Java.JavaCodeScriptEngine$InMemoryJavaFileManager.listUnder(JavaCodeScriptEngine.Java:401)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">at com.alibaba.ChaosBlade.exec.plugin.jvm.script.Java.JavaCodeScriptEngine$InMemoryJavaFileManager.find(JavaCodeScriptEngine.Java:390)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">at com.alibaba.ChaosBlade.exec.plugin.jvm.script.Java.JavaCodeScriptEngine$InMemoryJavaFileManager.list(JavaCodeScriptEngine.Java:375)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">at com.sun.tools.Javac.api.ClientCodeWrapper$WrappedJavaFileManager.list(ClientCodeWrapper.Java:231)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">at com.sun.tools.Javac.jvm.ClassReader.fillIn(ClassReader.Java:2796)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">at com.sun.tools.Javac.jvm.ClassReader.complete(ClassReader.Java:2446)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">at com.sun.tools.Javac.jvm.ClassReader.access$000(ClassReader.Java:76)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">at com.sun.tools.Javac.jvm.ClassReader$1.complete(ClassReader.Java:240)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">at com.sun.tools.Javac.code.Symbol.complete(Symbol.Java:574)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">at com.sun.tools.Javac.comp.MemberEnter.visitTopLevel(MemberEnter.Java:507)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">at com.sun.tools.Javac.tree.JCTree$JCCompilationUnit.accept(JCTree.Java:518)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">at com.sun.tools.Javac.comp.MemberEnter.memberEnter(MemberEnter.Java:437)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">at com.sun.tools.Javac.comp.MemberEnter.complete(MemberEnter.Java:1038)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">at com.sun.tools.Javac.code.Symbol.complete(Symbol.Java:574)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">at com.sun.tools.Javac.code.Symbol$ClassSymbol.complete(Symbol.Java:1037)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">at com.sun.tools.Javac.comp.Enter.complete(Enter.Java:493)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">at com.sun.tools.Javac.comp.Enter.main(Enter.Java:471)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">at com.sun.tools.Javac.main.JavaCompiler.enterTrees(JavaCompiler.Java:982)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">at com.sun.tools.Javac.main.JavaCompiler.compile(JavaCompiler.Java:857)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">at com.sun.tools.Javac.main.Main.compile(Main.Java:523)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">at com.sun.tools.Javac.api.JavacTaskImpl.doCall(JavacTaskImpl.Java:129)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">at com.sun.tools.Javac.api.JavacTaskImpl.call(JavacTaskImpl.Java:138)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">at com.alibaba.ChaosBlade.exec.plugin.jvm.script.Java.JavaCodeScriptEngine.compileClass(JavaCodeScriptEngine.Java:149)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">at com.alibaba.ChaosBlade.exec.plugin.jvm.script.Java.JavaCodeScriptEngine.compile(JavaCodeScriptEngine.Java:113)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">at com.alibaba.ChaosBlade.exec.plugin.jvm.script.base.AbstractScriptEngineService.doCompile(AbstractScriptEngineService.Java:82)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">at com.alibaba.ChaosBlade.exec.plugin.jvm.script.base.AbstractScriptEngineService.compile(AbstractScriptEngineService.Java:69)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">at com.alibaba.ChaosBlade.exec.plugin.jvm.script.model.DynamicScriptExecutor.run(DynamicScriptExecutor.Java:74)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">at com.alibaba.ChaosBlade.exec.common.injection.Injector.inject(Injector.Java:73)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">at com.alibaba.ChaosBlade.exec.common.aop.AfterEnhancer.afterAdvice(AfterEnhancer.Java:46)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">at com.alibaba.ChaosBlade.exec.common.plugin.MethodEnhancer.afterAdvice(MethodEnhancer.Java:47)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">at com.alibaba.ChaosBlade.exec.bootstrap.jvmsandbox.AfterEventListener.onEvent(AfterEventListener.Java:93)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">at com.alibaba.jvm.sandbox.core.enhance.weaver.EventListenerHandler.handleEvent(EventListenerHandler.Java:116)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">at com.alibaba.jvm.sandbox.core.enhance.weaver.EventListenerHandler.handleOnEnd(EventListenerHandler.Java:426)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">at com.alibaba.jvm.sandbox.core.enhance.weaver.EventListenerHandler.handleOnReturn(EventListenerHandler.Java:363)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>通过线程堆栈可以看到线程主要是在解压jar文件是阻塞了，为什么会阻塞到这里呢？</p><p>其实是在ChaosBlade 注入自定义脚本时，自定义脚本（Java代码）只是被当作一段字符串来处理，当真正的激活插件时会把这段字符串解析，然后变成Java代码让jvm进行加载编译并执行这段代码。</p><p><img loading="lazy" src="https://cdn.nlark.com/yuque/0/2022/png/215568/1662024674788-83a1c267-9a95-416b-a84c-c8a8c1ffbb5a.png#clientId=u854e1a66-dc20-4&amp;crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;from=ui&amp;id=u15e852b9&amp;margin=%5Bobject%20Object%5D&amp;name=%E8%84%9A%E6%9C%AC%E7%BC%96%E8%AF%91.png&amp;originHeight=666&amp;originWidth=1676&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=115604&amp;status=done&amp;style=none&amp;taskId=u046c9be7-044c-44ac-997a-b5d9a724362&amp;title=" alt="脚本编译.png" class="img_ev3q"></p><p><strong>问题就在这里,当故障注入时外部流量也是在源源不断的调用当前服务的。那么按照上面说的逻辑就有可能在激活插件时，因为外部流量也在不断调用，导致大量请求都来解析自定义脚本，这样的话就造成了线程被blocked，因为解析自定义脚本到正确的让jvm加载它，这个过程是相对复杂且缓慢的，而且有的地方是要保证线程安全的。</strong></p><blockquote><p>其实ChaosBlade 也做了缓存，只要自定义脚本被编译过一次，后面的请求就会直接执行这个脚本了，但这样的缓存在并发请求的场景下编译效果并不好</p></blockquote><h3 class="anchor anchorWithStickyNavbar_LWe7" id="423-优化">4.2.3 优化<a class="hash-link" href="#423-优化" title="Direct link to heading">​</a></h3><p>通过上面的排查，其实应该可以想到优化手段了，那就是要让自定义脚本的加载时间提前。</p><p>ChaosBlade注入故障分为两步,第一步挂载agent时拿不到自定义脚本信息，那么就在第二步<strong>激活插件前进行加载</strong>（因为一旦插件被激活后就有流量会执行到故障注入的埋点方法从而触发脚本的编译了）</p><p><img loading="lazy" src="https://cdn.nlark.com/yuque/0/2022/png/215568/1662024727494-f322ffc3-e397-406e-8d15-370d24673b78.png#clientId=u854e1a66-dc20-4&amp;crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;from=paste&amp;height=334&amp;id=ub7fddc91&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=668&amp;originWidth=1668&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=119885&amp;status=done&amp;style=none&amp;taskId=uaf619068-ab50-4976-8b63-5af78a7b60b&amp;title=&amp;width=834" alt="image.png" class="img_ev3q"></p><p><strong>这个优化思路不仅仅适用于自定义脚本故障，例如自定义抛异常故障也是可以的。</strong></p><p><strong>在自定义抛异常的故障执行中，也是当流量过来时才会根据用户输入的异常类字符进行反射加载，类的加载(classloader)底层也是需要加锁的，所以也有可能造成线程blocked.</strong></p><p>优化内容:增加故障前置执行接口，针对需要在故障注入前，执行某些动作的插件可以去实现它。</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public interface PreActionExecutor {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Pre run executor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param enhancerModel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @throws Exception</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void preRun(EnhancerModel enhancerModel) throws ExperimentException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">private void applyPreActionExecutorHandler(ModelSpec modelSpec, Model model)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        throws ExperimentException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ActionExecutor actionExecutor = modelSpec.getActionSpec(model.getActionName()).getActionExecutor();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (actionExecutor instanceof PreActionExecutor) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        EnhancerModel enhancerModel = new EnhancerModel(EnhancerModel.class.getClassLoader(), model.getMatcher());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        enhancerModel.merge(model);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ((PreActionExecutor) actionExecutor).preRun(enhancerModel);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>相关pr:<a href="https://github.com/chaosblade-io/chaosblade-exec-jvm/pull/269" target="_blank" rel="noopener noreferrer">https://github.com/ChaosBlade-io/ChaosBlade-exec-jvm/pull/269</a></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="43-日志打印优化">4.3 日志打印优化<a class="hash-link" href="#43-日志打印优化" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="431-问题描述">4.3.1 问题描述<a class="hash-link" href="#431-问题描述" title="Direct link to heading">​</a></h3><p>日志打印导致的CPU Idle跌底问题主要有两方面:</p><ol><li>业务系统内部自身的日志框架，例如使用log4j/logback同步日志打印，如果在注入故障后（例如抛异常）<strong>很有可能因为业务系统处理异常并打印日志导致线程大面积被blocked。</strong>因为同步日志打印是需要加锁处理，并且异常堆栈是相对内容较多的打印也相对耗时，从而当QPS较高时可能会导致大量线程被阻塞。</li></ol><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">- locked &lt;0x00000006f08422d0&gt; (a org.apache.log4j.DailyRollingFileAppender)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">at org.apache.log4j.helpers.AppenderAttachableImpl.appendLoopOnAppenders(AppenderAttachableImpl.Java:66)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">at org.apache.log4j.Category.callAppenders(Category.Java:206)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- locked &lt;0x00000006f086daf8&gt; (a org.apache.log4j.Logger)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">at org.apache.log4j.Category.forcedLog(Category.Java:391)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">at org.apache.log4j.Category.log(Category.Java:856)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">at org.slf4j.impl.Log4jLoggerAdapter.log(Log4jLoggerAdapter.Java:601)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" src="https://cdn.nlark.com/yuque/0/2022/png/215568/1662024805257-1df804ba-b2f4-4718-b85f-576efda49d21.png#clientId=u854e1a66-dc20-4&amp;crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;from=paste&amp;height=307&amp;id=u7fc7ec6d&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=435&amp;originWidth=612&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=115307&amp;status=done&amp;style=none&amp;taskId=u0fc9e5fd-9ce3-4d99-971d-b9c08f05cd2&amp;title=&amp;width=432" alt="image.png" class="img_ev3q"></p><ol start="2"><li>ChaosBlade 自身的日志打印,每次故障注入规则匹配成功时都会输出info日志</li></ol><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">LOGGER.info(&quot;Match rule: {}&quot;, JsonUtil.writer().writeValueAsString(model));</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>在输出日志的时候都会将故障模型使用jackson序列化输出,这会触发类加载（加锁操作）当有大量请求时可能会导致大量线程阻塞。</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Java.lang.Thread.State: RUNNABLE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">at Java.lang.String.charAt(String.Java:657)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">at Java.io.UnixFileSystem.normalize(UnixFileSystem.Java:87)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">at Java.io.File.&lt;init&gt;(File.Java:279)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">at sun.net.www.protocol.file.Handler.openConnection(Handler.Java:80)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- locked &lt;0x00000000c01f2740&gt; (a sun.net.www.protocol.file.Handler)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">at sun.net.www.protocol.file.Handler.openConnection(Handler.Java:72)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- locked &lt;0x00000000c01f2740&gt; (a sun.net.www.protocol.file.Handler)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">at Java.net.URL.openConnection(URL.Java:979)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">at sun.net.www.protocol.jar.JarFileFactory.getConnection(JarFileFactory.Java:65)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">at sun.net.www.protocol.jar.JarFileFactory.getPermission(JarFileFactory.Java:154)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">at sun.net.www.protocol.jar.JarFileFactory.getCachedJarFile(JarFileFactory.Java:126)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">at sun.net.www.protocol.jar.JarFileFactory.get(JarFileFactory.Java:81)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- locked &lt;0x00000000c00171f0&gt; (a sun.net.www.protocol.jar.JarFileFactory)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">at sun.net.www.protocol.jar.JarURLConnection.connect(JarURLConnection.Java:122)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">at sun.net.www.protocol.jar.JarURLConnection.getInputStream(JarURLConnection.Java:152)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">at Java.net.URL.openStream(URL.Java:1045)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">at Java.lang.ClassLoader.getResourceAsStream(ClassLoader.Java:1309)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">......</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">at Java.lang.reflect.Method.invoke(Method.Java:498)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">at com.fasterxml.jackson.databind.ser.BeanPropertyWriter.serializeAsField(BeanPropertyWriter.Java:689)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">at com.fasterxml.jackson.databind.ser.std.BeanSerializerBase.serializeFields(BeanSerializerBase.Java:755)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">at com.fasterxml.jackson.databind.ser.BeanSerializer.serialize(BeanSerializer.Java:178)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">at com.fasterxml.jackson.databind.ser.BeanPropertyWriter.serializeAsField(BeanPropertyWriter.Java:728)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">at com.fasterxml.jackson.databind.ser.std.BeanSerializerBase.serializeFields(BeanSerializerBase.Java:755)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">at com.fasterxml.jackson.databind.ser.BeanSerializer.serialize(BeanSerializer.Java:178)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">at com.fasterxml.jackson.databind.ser.DefaultSerializerProvider._serialize(DefaultSerializerProvider.Java:480)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">at com.fasterxml.jackson.databind.ser.DefaultSerializerProvider.serializeValue(DefaultSerializerProvider.Java:319)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">at com.fasterxml.jackson.databind.ObjectWriter$Prefetch.serialize(ObjectWriter.Java:1516)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">at com.fasterxml.jackson.databind.ObjectWriter._writeValueAndClose(ObjectWriter.Java:1217)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">at com.fasterxml.jackson.databind.ObjectWriter.writeValueAsString(ObjectWriter.Java:1086)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">at com.alibaba.ChaosBlade.exec.common.injection.Injector.inject(Injector.Java:69)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">at com.alibaba.ChaosBlade.exec.common.aop.AfterEnhancer.afterAdvice(AfterEnhancer.Java:46)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">at com.alibaba.ChaosBlade.exec.common.plugin.MethodEnhancer.afterAdvice(MethodEnhancer.Java:47)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">at com.alibaba.ChaosBlade.exec.bootstrap.jvmsandbox.AfterEventListener.onEvent(AfterEventListener.Java:93)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">at com.alibaba.jvm.sandbox.core.enhance.weaver.EventListenerHandler.handleEvent(EventListenerHandler.Java:116)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">at com.alibaba.jvm.sandbox.core.enhance.weaver.EventListenerHandler.handleOnEnd(EventListenerHandler.Java:426)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">at com.alibaba.jvm.sandbox.core.enhance.weaver.EventListenerHandler.handleOnReturn(EventListenerHandler.Java:363)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">at Java.com.alibaba.jvm.sandbox.spy.Spy.spyMethodOnReturn(Spy.Java:192)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="432-优化">4.3.2 优化<a class="hash-link" href="#432-优化" title="Direct link to heading">​</a></h3><p>关于业务系统的日志打印引发的线程block，不在ChaosBlade优化的范围内，大家有遇到类似情况可以自行解决。</p><p>解决的思路:</p><ol><li>日志同步打印改为异步打印</li><li>ChaosBlade自定义抛异常时的错误堆栈可以尽量忽略，减少日志输出的内容。</li></ol><p>关于ChaosBlade 打印日志的优化就比较简单了，只需要将match rule序列化故障模型的部分替换掉即可。将Model实现toString，打印时直接打印Model即可。</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">LOGGER.info(&quot;Match rule: {}&quot;, model);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public String toString() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return &quot;Model{&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;target=&#x27;&quot; + target + &#x27;\&#x27;&#x27; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;, matchers=&quot; + matcher.getMatchers().toString() +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;, action=&quot; + action.getName() +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &#x27;}&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>相关pr:<a href="https://github.com/chaosblade-io/chaosblade-exec-jvm/pull/260" target="_blank" rel="noopener noreferrer">https://github.com/ChaosBlade-io/ChaosBlade-exec-jvm/pull/260</a></p><h1>5.Metaspace OOM优化</h1><p>Metaspace 是什么，引用官方介绍</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Metaspace is a native (as in: off-heap) memory manager in the hotspot.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">It is used to manage memory for class metadata. Class metadata are allocated when classes are loaded. </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Their lifetime is usually scoped to that of the loading classloader - when a loader gets collected, all class metadata it accumulated are released in bulk.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>简单来说：Metapace 是一块非堆内存，用来存储类的元数据，当加载类的时候会在 Metaspace 中分配空间存储类的元数据，当某个 ClassLoader 关闭时会对应释放掉对类元数据的引用，当触发 GC 时这部分类元数据占用的空间即可在 Metaspace 中被回收掉。</strong></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="51-现象">5.1 现象<a class="hash-link" href="#51-现象" title="Direct link to heading">​</a></h2><p><strong>日志表现</strong></p><p>在使用ChaosBlade注入无效后，登陆目标机器上观察日志，首先发现 jvm-sandbox 在 attach 目标 jvm 时失败</p><p><img loading="lazy" src="https://cdn.nlark.com/yuque/0/2022/png/215568/1662025134235-ccc6d0c6-f059-4024-8b21-e6f108ef0d4e.png#clientId=u854e1a66-dc20-4&amp;crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;from=paste&amp;height=146&amp;id=u252466f4&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=291&amp;originWidth=1920&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=565948&amp;status=done&amp;style=none&amp;taskId=u6ffeaa9f-3222-47f4-b5ee-9e6f0eab537&amp;title=&amp;width=960" alt="image.png" class="img_ev3q"></p><p>其次看到更关键的日志:Metaspace 溢出了！！！</p><p><img loading="lazy" src="https://cdn.nlark.com/yuque/0/2022/png/215568/1662025159003-cbe3e050-32c9-4cea-8bfb-b3950170f51c.png#clientId=u854e1a66-dc20-4&amp;crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;from=paste&amp;height=343&amp;id=u74144a61&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=686&amp;originWidth=1920&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=1121123&amp;status=done&amp;style=none&amp;taskId=u9e3ca2a4-cdec-419c-ab47-d1dfa4a9426&amp;title=&amp;width=960" alt="image.png" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="52-定位">5.2 定位<a class="hash-link" href="#52-定位" title="Direct link to heading">​</a></h2><p>在文章开始介绍了ChaosBlade注入Java故障的流程，知道在故障注入时会将 jvm-sandbox 动态的挂载(attach)到目标进程 JVM 上,在 attach 后会加载 sandbox 内部 jar 以及 sandbox 的自定义模块 jar 等，在这个过程中会加载大量的类，当加载类时会分配 Metaspace 空间存储类的元数据。</p><p>这里有两个思考点:</p><ol><li><strong>会不会是因为业务服务 JVM 的 Metaspace 空间设置的太小？</strong></li><li><strong>Metaspace 的 GC 没有触发或者是有泄露导致类的元数据回收不掉？</strong></li></ol><p>登陆到目标机器上利用 jinfo 观察 jvm 的参数,发现 MaxMetaspaceSize 设置了 128M，这个值确实不大，因为 MaxMetaspaceSize 的默认是-1(无限制，受限于本地内存)。</p><p>让业务服务调整 MaxMetaspaceSize 参数改为 256M，然后重启 Java 进程，再次故障注入 确实没问题了，故障正常生效了。</p><p><strong>但实际问题没怎么简单，在连续注入多次后依然出现 Metaspace OOM 故障依旧无效。看来应该是故障清除时无法回收掉 Metaspace 中对应的空间。</strong></p><p><strong>本地复现</strong></p><p>由于ChaosBlade Java故障注入本质是jvm-sandbox的一个插件，类加载，字节码增强等核心逻辑都在jvm-sandebox上，所以我们直接将问题定位在jvm-sandbox上，利用jvm-sandbox提供的demo项目进行复现。</p><p>启动参数设置了 MaxMetaspaceSize=30M，因为 demo 模块类非常少，其次为了快速的复现 OOM。</p><p>TraceClassLoading 和 TraceClassUnloding 参数则是为了观察 JVM-SANDBOX 在故障注入和清除时加载/卸载类的信息。</p><p><img loading="lazy" src="https://cdn.nlark.com/yuque/0/2022/png/215568/1662025224907-466c59fa-2368-42ac-b8d0-310a69b2dc3f.png#clientId=u4157e217-e5f5-4&amp;crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;from=paste&amp;height=392&amp;id=ub4ebcc30&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=784&amp;originWidth=1420&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=110130&amp;status=done&amp;style=none&amp;taskId=u3515020a-9a7c-4358-94e5-8d9ce0b9432&amp;title=&amp;width=710" alt="image.png" class="img_ev3q"></p><p>在多次注入以及清除的操作后，复现了线上业务出现的 Metaspace OOM，可以看到在多次注入的过程中，Metaspace 一直没有被回收过，占用空间曲线是一路上升。</p><p><img loading="lazy" src="https://cdn.nlark.com/yuque/0/2022/png/215568/1662025257540-54ad0e55-7bbb-4d6b-b974-254e786d8a72.png#clientId=u4157e217-e5f5-4&amp;crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;from=paste&amp;height=661&amp;id=u548266fd&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=1321&amp;originWidth=1920&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=200347&amp;status=done&amp;style=none&amp;taskId=uab1cb32a-8508-4f99-8943-d602ae934ed&amp;title=&amp;width=960" alt="image.png" class="img_ev3q"></p><p><strong>Metaspace OOM 是因为 Metaspace 没有进行过回收，Metaspace 回收的前提是 ClassLoader 关闭，而 JVM-SANDBOX 在 shutdown 时会关闭 ClassLoader。JVM-SANDBOX 中自定义的 ClassLoader 都是继承了 URLClassLoader，URLClassLoader 的关闭方法 官方介绍：</strong></p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">How to Close a URLClassLoader?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">The URLClassLoader close() method effectively eliminates the problem of how to support updated implementations of the classes and resources loaded from a particular codebase, and in particular from JAR files. In principle, once the application clears all references to a loader object, the garbage collector and finalization mechanisms will eventually ensure that all resources (such as the JarFile objects) are released and closed.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>简单来说：当 classLoader 加载的所有类没有被引用时即可被关闭。</p><p><strong>猜想</strong>
<strong>当故障清除时 jvm-sandbox 中的类还有被引用的情况导致 classloader 关闭失败了。</strong></p><p><strong>验证猜想</strong>
<strong>在故障清除后，在目标服务的方法上 debug 看一下线程信息，果然在 threadLocal 中找到了两个 jvm-sandbox 的内部类（EventProcesser$Process,SandboxProtector）的引用。说明猜想是对的，问题的原因就是出现在这里了</strong></p><p><img loading="lazy" src="https://cdn.nlark.com/yuque/0/2022/png/215568/1662025409608-049339d0-4065-4e90-b6de-d27fd125b5f6.png#clientId=u90f09cf4-59dc-4&amp;crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;from=paste&amp;height=662&amp;id=u56284955&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=1324&amp;originWidth=1920&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=677495&amp;status=done&amp;style=none&amp;taskId=u3ddb2694-e1f6-4055-870b-c894ab9c7a5&amp;title=&amp;width=960" alt="image.png" class="img_ev3q"></p><p>jvm-sandbox源码在这里就不带大家分析了，感兴趣的可以查看这篇<a href="https://xie.infoq.cn/article/c5be9834709f7eb48cfa683b1" target="_blank" rel="noopener noreferrer">文章</a>。主要是 jvm-sandbox 的代码实现有 bug，在以下两种情况会导致 processRef 的 ThreadLocal 没有及时 remove 造成泄漏</p><ol><li>假如在执行注入故障的过程中，进行故障清除会导致泄漏。如下：</li></ol><p><img loading="lazy" src="https://cdn.nlark.com/yuque/0/2022/png/215568/1662025438733-39f99d72-7d45-477d-8bae-1b4fe23fa0db.png#clientId=u90f09cf4-59dc-4&amp;crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;from=paste&amp;height=612&amp;id=u5597fc7a&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=1224&amp;originWidth=1556&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=1398788&amp;status=done&amp;style=none&amp;taskId=ud0fe7ed4-f453-4fdb-b725-562334731c6&amp;title=&amp;width=778" alt="image.png" class="img_ev3q"></p><ol start="2"><li>假设使用了 jvm-sandbox 的特性-流程变更（例如立即返回，立即抛出异常），本质也是 thread local 没有及时 remove，导致造成了泄漏</li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="53-优化">5.3 优化<a class="hash-link" href="#53-优化" title="Direct link to heading">​</a></h2><p>由于jvm-sandbox项目已经不在活跃了，我们将jvm-sandbox项目fork到了ChaosBlade中。
优化后的相关pr:<a href="https://github.com/chaosblade-io/jvm-sandbox/pull/1" target="_blank" rel="noopener noreferrer">https://github.com/ChaosBlade-io/jvm-sandbox/pull/1</a></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="54-改进后效果">5.4 改进后效果<a class="hash-link" href="#54-改进后效果" title="Direct link to heading">​</a></h2><p>启动参数还是相同的 MaxMetaspaceSize=30M，经过优化后多次注入和清除不会出现 Metaspace OOM，Metaspace可以被回收了。</p><p><img loading="lazy" src="https://cdn.nlark.com/yuque/0/2022/png/215568/1662025496836-b6895072-2d92-46ea-ba0f-59ab65035aff.png#clientId=u90f09cf4-59dc-4&amp;crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;from=paste&amp;height=638&amp;id=u39968c09&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=1275&amp;originWidth=1920&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=143820&amp;status=done&amp;style=none&amp;taskId=ub9a9c81b-5e4b-42d7-942a-51a6015c5c6&amp;title=&amp;width=960" alt="image.png" class="img_ev3q"></p><p>卸载类的信息也打印出来了</p><p><img loading="lazy" src="https://cdn.nlark.com/yuque/0/2022/png/215568/1662025512805-62c158bc-61fc-4443-befd-b10445f9fb92.png#clientId=u90f09cf4-59dc-4&amp;crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;from=paste&amp;height=344&amp;id=u051ce70b&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=687&amp;originWidth=1920&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=344964&amp;status=done&amp;style=none&amp;taskId=uebfee1f3-f546-47a5-a96e-0725dace717&amp;title=&amp;width=960" alt="image.png" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="54-再次优化">5.4 再次优化<a class="hash-link" href="#54-再次优化" title="Direct link to heading">​</a></h2><p><strong>虽然我们解决了JVM-Sandbox的ThreadLocal泄漏问题，但是由于Metaspace的内存分配以及回收机制还是有可能导致OOM!!!.</strong></p><blockquote><p><strong>关于Metaspace的内存分配以及回收的相关内容可以参考</strong><a href="https://www.javadoop.com/post/metaspace" target="_blank" rel="noopener noreferrer">文章</a></p></blockquote><p>上面的优化基础上还需要在每一次故障注入前触发一次full gc，目的是让上一次jvm-sandbox占用的元空间强制释放掉。</p><p>改动点:</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public static void agentmain(String featureString, Instrumentation inst) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    System.gc();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    LAUNCH_MODE = LAUNCH_MODE_ATTACH;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    final Map&lt;String, String&gt; featureMap = toFeatureMap(featureString);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    writeAttachResult(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            getNamespace(featureMap),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            getToken(featureMap),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            install(featureMap, inst)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这样的改动的虽然能解决一部分场景下的Metaspace OOM，但是也有弊端,这样会导致每一次故障注入挂载agent时都会触发一次full GC,到目前为止还没有更好的解决办法，后面可以考虑将这个full gc做成配置，通过sandbox脚本来进行开启，让用户按需选择是否要在注入前强制full gc一次。</p><p>相关pr:<a href="https://github.com/chaosblade-io/jvm-sandbox/pull/6" target="_blank" rel="noopener noreferrer">https://github.com/ChaosBlade-io/jvm-sandbox/pull/6</a></p><p>那么如何彻底解决Metaspace OOM问题呢？先说结论：不能彻底解决，因为在使用反射的情况下会自动生成一些（sun.reflect.DelegatingClassLoader），所以在业务代码中很难去关闭，那就导致DelegatingClassLoader会一直存活，从而引发Metaspace 碎片化的问题，最终导致Metaspace空间无法被正确的回收（这部分内容比较复杂，一言两语很难描述清楚）</p><a name="grkSk"></a>## 5.5 思考 关于Metaspace OOM的问题，其实优化是一方面，换个角度想也许是我们使用的方式不正确。在我们的业务场景下是会频繁的对一个服务进行故障注入&amp;卸载，每次的注入点不同。<p>如下图: 相当于每次都是重复1-4步骤，那么实际上我们并不需要这么做，因为在第一步时sandbox初始化会加载大量的类，填充metaspace。而我们每次注入只是故障点不同,agent不需要重新挂载，所以只需要重复的进行第2步和第三步即可。 在第2步和第3步中只是触发sandbox的激活和冻结事件，成本非常小。</p><p>后面我们会根据这个思路，对整个故障注入流程进行优化，相信会有更多的提升。</p><p><img loading="lazy" src="https://cdn.nlark.com/yuque/0/2022/png/215568/1662372406854-f575ffcf-01f9-4832-ae28-280d4b1848eb.png#clientId=u72ad57af-f46a-4&amp;crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;from=paste&amp;height=371&amp;id=ue01bb516&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=742&amp;originWidth=1584&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=185312&amp;status=done&amp;style=none&amp;taskId=ue7756adc-9d3d-40e1-a8d8-27adc8ff130&amp;title=&amp;width=792" alt="image.png" class="img_ev3q"></p><h1>6.JIT(及时编译)导致CPU抖动</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="61-问题描述">6.1 问题描述<a class="hash-link" href="#61-问题描述" title="Direct link to heading">​</a></h2><p>在Java中编译器主要分为三类：</p><ol><li>前端编译器:JDK的Javac，即把<em>.Java文件转变成</em>.class文件的过程</li><li>即时编译器:HotSpot虚拟机的C1,C2编译器,Graal编译器，JVM运行期把字节码转变成本地机器码的过程</li><li>提前编译器:JDK的Jaotc,GNU Compiler for the Java(GCJ)等</li></ol><p>在通过ChaosBlade进行故障注入后，本质是利用jvm-sandbox对目标类和放火进行了字节码增强。从而也会触发JVM的即时编译（JIT-	Just In Time）</p><p>JVM的即时编译目的是让字节码转换为机器码，从而可以更高效的执行。但是在JVM即时编译的过程中是会消耗资源的，最典型的场景就是Java的服务 在刚启动时CPU的使用率都会相对较高，一段时间后逐渐恢复平稳，出现这种现象部分情况下是因为即时编译的介入导致的。关于即时编译的内容可以参考<a href="https://xie.infoq.cn/article/dacbe19251f8ec828efacdfde" target="_blank" rel="noopener noreferrer">文章</a></p><p>对于即时编译引发的CPU使用率升高是正常现象，如果遇到JIT占用的CPU 使用率特别高，我们需要特殊关注下即时编译的参数即可。例如是否启用了分层编译，编译的线程数量等等。</p><h1>7.总结</h1><p>ChaosBlade 支持丰富的故障注入场景，尤其是在Java 生态中支持大量的插件。对于Java 场景的故障注入优势比较明显。</p><p>通过对上面介绍的问题进行优化，使用ChaosBlade进行Java场景的故障注入不会再导致CPU Idle跌底，即使在线上运行的服务进行故障注入也会将CPU的抖动控制在一个较小的波动范围。</p><p>但由于JVM JIT的问题在故障注入时CPU的瞬时抖动还是无法避免，如果大家有什么好的办法/想法也欢迎提交issue/pr来共同交流～</p><blockquote><p>ChaosBlade 官方网址：<a href="https://chaosblade.io/" target="_blank" rel="noopener noreferrer">https://chaosblade.io/</a>
ChaosBlade Github : <a href="https://github.com/chaosblade-io/chaosblade" target="_blank" rel="noopener noreferrer">https://github.com/chaosblade-io/chaosblade</a>
ChaosBlade 钉钉社区交流群:23177705</p></blockquote></div><footer class="row docusaurus-mt-lg blogPostFooterDetailsFull_mRVl"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/en/blog/tags/chaosblade">chaosblade</a></li></ul></div><div class="col margin-top--sm"><a href="https://github.com/chaosblade-io/chaosblade-website/edit/master/website/blog/blog/2022-09-09-chaosblade-java.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--next" href="/en/blog/2022/06/24/ChaosBlade-Box-a-New-Version-of-the-Chaos-Engineering-Platform-Has-Released-ch"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">ChaosBlade-Box全新混沌工程平台 -- 助力企业混沌工程落地</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#31-现象" class="table-of-contents__link toc-highlight">3.1 现象</a></li><li><a href="#32-定位" class="table-of-contents__link toc-highlight">3.2 定位</a></li><li><a href="#33-优化" class="table-of-contents__link toc-highlight">3.3 优化</a></li><li><a href="#34-改进后效果" class="table-of-contents__link toc-highlight">3.4 改进后效果</a></li><li><a href="#41-dubbo故障优化" class="table-of-contents__link toc-highlight">4.1 dubbo故障优化</a><ul><li><a href="#411-问题描述" class="table-of-contents__link toc-highlight">4.1.1 问题描述</a></li><li><a href="#412-优化" class="table-of-contents__link toc-highlight">4.1.2 优化</a></li></ul></li><li><a href="#42-自定义脚本故障优化" class="table-of-contents__link toc-highlight">4.2 自定义脚本故障优化</a><ul><li><a href="#421-问题描述" class="table-of-contents__link toc-highlight">4.2.1 问题描述</a></li><li><a href="#422-问题排查" class="table-of-contents__link toc-highlight">4.2.2 问题排查</a></li><li><a href="#423-优化" class="table-of-contents__link toc-highlight">4.2.3 优化</a></li></ul></li><li><a href="#43-日志打印优化" class="table-of-contents__link toc-highlight">4.3 日志打印优化</a><ul><li><a href="#431-问题描述" class="table-of-contents__link toc-highlight">4.3.1 问题描述</a></li><li><a href="#432-优化" class="table-of-contents__link toc-highlight">4.3.2 优化</a></li></ul></li><li><a href="#51-现象" class="table-of-contents__link toc-highlight">5.1 现象</a></li><li><a href="#52-定位" class="table-of-contents__link toc-highlight">5.2 定位</a></li><li><a href="#53-优化" class="table-of-contents__link toc-highlight">5.3 优化</a></li><li><a href="#54-改进后效果" class="table-of-contents__link toc-highlight">5.4 改进后效果</a></li><li><a href="#54-再次优化" class="table-of-contents__link toc-highlight">5.4 再次优化</a></li><li><a href="#61-问题描述" class="table-of-contents__link toc-highlight">6.1 问题描述</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/en/docs">About ChaosBlade</a></li><li class="footer__item"><a class="footer__link-item" href="/en/docs/community/docs">Contribute documents</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://gitter.im/chaosblade-io/community" target="_blank" rel="noopener noreferrer" class="footer__link-item">Gitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/chaosblade.io" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://join.slack.com/t/chaosblade-io/shared_invite/zt-f0d3r3f4-TDK13Wr3QRUrAhems28p1w" target="_blank" rel="noopener noreferrer" class="footer__link-item">Slack<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/en/">DingTalk(23177705)</a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.netlify.com"><img src="https://www.netlify.com/img/global/badges/netlify-color-accent.svg" alt="Deploys by Netlify"></a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a href="https://cncf.io/" rel="noopener noreferrer" class="footerLogoLink_BH7S"><img src="/en/img/cncf-white.svg" alt="CNCF" class="themedImage_ToTc themedImage--light_HNdA footer__logo"><img src="/en/img/cncf-white.svg" alt="CNCF" class="themedImage_ToTc themedImage--dark_i4oU footer__logo"></a></div><div class="footer__copyright">© 2022 The ChaosBlade Authors. All rights reserved. <br>
            The Linux Foundation has registered trademarks and uses trademarks. 
            For a list of trademarks of The Linux Foundation, 
            please see our <a href="https://www.linuxfoundation.org/trademark-usage/"> Trademark Usage</a> page.</div></div></div></footer></div>
<script src="/en/assets/js/runtime~main.3e71e79d.js"></script>
<script src="/en/assets/js/main.67b64ba6.js"></script>
</body>
</html>